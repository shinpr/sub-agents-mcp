/**
 * セッション情報
 *
 * サブエージェント実行時の過去のリクエスト・レスポンス履歴を保持する。
 * MCPサーバーが自律的に管理し、複数クライアント間で共有される。
 */
export interface SessionData {
  /**
   * セッションID
   *
   * 一意なセッション識別子。UUID v4形式を推奨。
   * ディレクトリトラバーサル攻撃を防ぐため、英数字とハイフン、アンダースコアのみを許容。
   */
  sessionId: string

  /**
   * エージェントタイプ
   *
   * このセッションで使用されるエージェントの種類（例: "rule-advisor", "cursor"）。
   * ファイル命名規則に使用される。
   */
  agentType: string

  /**
   * セッション履歴エントリのリスト
   *
   * 過去のリクエスト・レスポンスの時系列記録。
   * 古いエントリから新しいエントリの順に格納される。
   */
  history: SessionEntry[]

  /**
   * セッション作成日時
   *
   * このセッションが最初に作成された日時。
   * クリーンアップ処理で保持期間の判定に使用される。
   */
  createdAt: Date

  /**
   * 最終更新日時
   *
   * このセッションが最後に更新された日時。
   * 新しいリクエスト・レスポンスが追加されるたびに更新される。
   */
  lastUpdatedAt: Date
}

/**
 * セッション履歴エントリ
 *
 * 1回のサブエージェント実行におけるリクエストとレスポンスのペア。
 * 時系列順にSessionData.historyに格納される。
 */
export interface SessionEntry {
  /**
   * エントリのタイムスタンプ
   *
   * このリクエスト・レスポンスが記録された日時。
   * 履歴の順序付けに使用される。
   */
  timestamp: Date

  /**
   * リクエスト情報
   *
   * サブエージェントに送信されたリクエストの詳細。
   * ExecutionParamsと互換性のある構造を持つ。
   */
  request: {
    /**
     * エージェント名
     *
     * 実行されたエージェントの名前（例: "rule-advisor", "quality-fixer"）。
     */
    agent: string

    /**
     * プロンプト
     *
     * エージェントに送信されたユーザー指示や質問。
     */
    prompt: string

    /**
     * 作業ディレクトリ（オプショナル）
     *
     * エージェント実行時の作業ディレクトリパス。
     * 指定がない場合は現在の作業ディレクトリが使用される。
     */
    cwd?: string

    /**
     * 追加引数（オプショナル）
     *
     * エージェント実行時に渡される追加のコマンドライン引数。
     */
    extra_args?: string[]
  }

  /**
   * レスポンス情報
   *
   * サブエージェント実行の結果。
   * ExecutionResultと互換性のある構造を持つ。
   */
  response: {
    /**
     * 標準出力
     *
     * エージェント実行時の標準出力内容。
     * エージェントの主要な応答や結果がここに含まれる。
     */
    stdout: string

    /**
     * 標準エラー出力
     *
     * エージェント実行時の標準エラー出力内容。
     * 警告メッセージやデバッグ情報が含まれることがある。
     */
    stderr: string

    /**
     * 終了コード
     *
     * エージェントプロセスの終了コード。
     * 0は正常終了、非0はエラーを示す。
     */
    exitCode: number

    /**
     * 実行時間（ミリ秒）
     *
     * エージェント実行にかかった時間（ミリ秒単位）。
     * パフォーマンス分析に使用される。
     */
    executionTime: number
  }
}

/**
 * セッション設定
 *
 * セッション管理機能の動作を制御する設定値。
 * 環境変数から読み込まれ、SessionManagerの初期化時に使用される。
 */
export interface SessionConfig {
  /**
   * セッション管理の有効化フラグ
   *
   * trueの場合、セッション保存・読み込み機能が有効になる。
   * falseの場合、セッション機能は完全に無効化され、既存動作を維持する。
   * 環境変数 SESSION_ENABLED で制御される。
   */
  enabled: boolean

  /**
   * セッションファイルの保存ディレクトリ
   *
   * セッションJSONファイルが保存されるディレクトリのパス。
   * ディレクトリが存在しない場合は自動的に作成される。
   * 環境変数 SESSION_DIR で制御される。
   */
  sessionDir: string

  /**
   * セッションファイルの保持期間（日数）
   *
   * この日数より古いセッションファイルはクリーンアップ時に削除される。
   * ベストエフォート実行で、削除失敗しても処理は継続される。
   * 環境変数 SESSION_RETENTION_DAYS で制御される。
   */
  retentionDays: number
}

/**
 * セッション保存結果
 *
 * SessionManager.saveSession() の実行結果を表すメタデータ。
 * エラー分離設計により、保存失敗しても本流処理は継続される。
 */
export interface SessionSaveResult {
  /**
   * 保存成功フラグ
   *
   * trueの場合、セッションファイルの保存に成功。
   * falseの場合、保存に失敗したがエラーログのみ出力され、本流処理は継続される。
   */
  success: boolean

  /**
   * セッションID
   *
   * 保存対象のセッション識別子。
   * 成功・失敗にかかわらず常に設定される。
   */
  sessionId: string

  /**
   * 保存されたファイルパス（オプショナル）
   *
   * 保存に成功した場合のみ設定される。
   * ファイル命名規則: [session_id]_[agent_type]_[timestamp].json
   */
  filePath?: string

  /**
   * エラーメッセージ（オプショナル）
   *
   * 保存に失敗した場合のみ設定される。
   * デバッグ用の詳細なエラー情報が含まれる。
   */
  error?: string
}
